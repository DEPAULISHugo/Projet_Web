<!DOCTYPE html>
<html lang="fr">

  <head>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/leaflet.js"></script>

    <link rel="stylesheet" href="Carte.css">

    <title>Mission papillon</title>
  </head>

  <body>

    <form name="chrono">
      <input type="text" name="chrono" id="compteur" value="00:00:00"/>
      <input id="stop" type=button onclick="redirection(), chronoStop()"; value="" />
    </form>

    <div class="barre">
      <div class="progression">
        <div class="valeur">
            Ajouter la valeur de la progression
        </div>
      </div>
    </div>


    <div id="macarte"></div>
    <script>
      var carte = L.map('macarte').setView([16.165, -61.5], 10);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: ' <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
      }).addTo(carte);

      /* DEBUT MODIFICATION */

      var listLayers = [];

      for (var i = 0 ; i < 19 ; i++){
        listLayers[i] = new L.LayerGroup();
        carte.addLayer(listLayers[i]);
      }

      var listObjets = [];
      var listObjetsPossedes = [];
      var objetUtilise = null;

      function getObjetByID(id){
        var ajax = new XMLHttpRequest();
        ajax.open('GET', 'serveur.php/?id='+id);
        ajax.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
        ajax.addEventListener('load',  function () {
          var objet = JSON.parse(ajax.response);
          var newObjet = new Objet(objet.id, objet.name, objet.latitude, objet.longitude, objet.minZoom, objet.icone, objet.texte);
          listObjets[listObjets.length] = newObjet;
          newObjet.afficherObjet();
        });
        ajax.send("id="+id);
      }

      class Objet {
        constructor (id, name, lat, lng, minZoom, icone, texte) {
          this.id = id;
          this.name = name;
          this.lat = lat;
          this.lng = lng;
          this.minZoom = minZoom;
          this.icone = icone;
          this.texte = texte;
          this.vu = false;
          this.idBloquant = null;
          this.code = null;
          this.texteDebloque = null;
          this.iconMap = L.icon({
            iconUrl: this.icone,
            shadowUrl: 'shadow.png',

            iconSize:     [50, 50], // size of the icon
            shadowSize:   [50, 50], // size of the shadow
            iconAnchor:   [25, 25], // point of the icon which will correspond to marker's location
            shadowAnchor: [25, 25],  // the same for the shadow
            popupAnchor:  [0, -25] // point from which the popup should open relative to the iconAnchor
          });
        this.marker = L.marker([this.lat, this.lng], {icon: this.iconMap});
        }
        afficherObjet(){
          this.marker.bindPopup(this.texte);
          this.marker.addTo(listLayers[this.minZoom - 1]).on("click", markerOnClick);
          this.marker.on("mouseover", markerMouseOver);
          this.marker.on("mouseout", markerMouseOut);
        }
        retirerObjet(){
          listLayers[this.minZoom - 1].removeLayer(this.marker);
        }
        recupererObjet(){
          this.retirerObjet();
          listObjetsPossedes[listObjetsPossedes.length] = this;
          var cadre = document.getElementById("boite"+listObjetsPossedes.length);
          cadre.innerHTML = '<img src="'+this.icone+'" class=imageObjets alt="Oups !">';
          cadre.addEventListener("click", function(){
            var idObjet = listObjetsPossedes[this.id.charAt(5) - 1].id;
            if (objetUtilise == null){
              objetUtilise = idObjet;
              this.style.backgroundColor = "grey";
            }
            else if (objetUtilise == idObjet){
              objetUtilise = null;
              this.style.backgroundColor = "white";
            }
            else{
              var ancienCadre = getCadreObjetUtilise();
              ancienCadre.style.backgroundColor = "white";
              objetUtilise = idObjet;
              this.style.backgroundColor = "grey";
            }
          });
        }
        debloquerObjet(clickedMarker){
          this.idBloquant = null;
          clickedMarker.bindPopup(this.texteDebloque).openPopup();
          var cadreObjetUtilise = getCadreObjetUtilise();
          cadreObjetUtilise.style.backgroundColor = "white";
          objetUtilise = null;
        }
        action() {
          /*Recherche de ce qui pourrait bloquer l'objet : autre objet ou code*/
          var ajax = new XMLHttpRequest();
          ajax.open('GET', 'serveur.php/?idBloque='+this.id);
          ajax.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
          ajax.addEventListener('load',  function () {
            var response = JSON.parse(ajax.response);
            if (response.idBloque != -1) {
              /*L'objet est bien bloqué par quelque chose*/
              if (response.type == "objet"){
                /*L'objet est bloqué par un autre objet*/
                listObjets[response.idBloque].idBloquant = response.idBloquant;
                listObjets[response.idBloque].texteDebloque = response.texteDebloque;
                getObjetByID(response.idBloquant);
              }
              else if (response.type == "code"){
                /*L'objet est bloqué par un code*/
                listObjets[response.idBloque].code = response.code;
                listObjets[response.idBloque].texteDebloque = response.texteDebloque;
              }
            }
          });
          ajax.send("idBloque="+this.id);
        }
      }

      carte.on('zoomend', function() {
        for (var i = 0 ; i < 19 ; i++){
          if (carte.getZoom() > i){
              carte.addLayer(listLayers[i]);
            }
            else {
              carte.removeLayer(listLayers[i]);
            }
        }
      });

      function markerOnClick(e) {
        var clickedMarker = e.target;
        var objet = getObjetByMarker(clickedMarker);
        if (objet.idBloquant == null && objet.code == null){
          /*L'objet n'est bloqué ni par un code ni par un objet, on peut donc le récupérer*/
          objet.recupererObjet();
        }
        else if (objet.idBloquant != null && objet.idBloquant == objetUtilise){
          /*L'objet est bloqué, mais on a l'objet pour le débloquer*/
          objet.debloquerObjet(clickedMarker);
        }
        else if (objet.code != null){
          /*L'objet est bloqué par code*/
          var formulaire = '<input type="text" name="code" id="code'+objet.id+'"><button type="button" value="'+objet.id+'" name="'+objet.id+'" id="valider">Valider</button>';
          clickedMarker.bindPopup(formulaire).openPopup();
          var buttonValider = document.getElementById("valider");
          buttonValider.addEventListener("click", function(){
            var idObjet = this.value;
            var objet = listObjets[idObjet];
            var codeEntre = document.getElementById("code"+idObjet).value;
            if (codeEntre == objet.code){
              objet.code = null;
              objet.marker.bindPopup(objet.texteDebloque).openPopup();
            }else {
              markerOnClick(e);
            }
          });
        }
      }

      function markerMouseOver(e) {
        var clickedMarker = e.target;
        var objet = getObjetByMarker(clickedMarker);
        clickedMarker.openPopup();
        if (objet.vu == false) {
          objet.vu = true;
          objet.action();
        }
      }

      function markerMouseOut(e) {
        var clickedMarker = e.target;
        var objet = getObjetByMarker(clickedMarker);
        if (clickedMarker._popup._content.indexOf("<input") == -1){
          clickedMarker.closePopup();
        }
      }

      function getObjetByMarker(marker){
        for (var i = 0 ; i < listObjets.length ; i++) {
          if (listObjets[i].lat == marker._latlng.lat && listObjets[i].lng == marker._latlng.lng){
            return listObjets[i];
          }
        }
      }

      function getCadreObjetUtilise(){
        var id;
        for (var i = 0 ; i < listObjetsPossedes.length ; i++){
          if (objetUtilise == listObjetsPossedes[i].id){
            id = i;
          }
        }
        var cadreObjetUtilise = document.getElementById("boite"+(id+1));
        return cadreObjetUtilise;
      }

      getObjetByID(0);

      /* FIN MODIFICATION */

    </script>

    <div id="audio">
      <audio id="son" autoplay loop preload="auto">
        <source src="Lava Laboratory - Roblox Escape Room Music.mp3" type="audio/mp3" />
      </audio>

      <input type="range" min="0" max="1" step="0.1" value="1" id="volume" onchange="changeVolume()">
    </div>

    <div>
      <div class="rangement" id="boite1"><img src="shadow.png" class=imageObjets alt="Oups !"></div>
      <div class="rangement" id="boite2"><img src="shadow.png" class=imageObjets alt="Oups !"></div>
      <div class="rangement" id="boite3"><img src="shadow.png" class=imageObjets alt="Oups !"></div>
      <div class="rangement" id="boite4"><img src="shadow.png" class=imageObjets alt="Oups !"></div>
      <div class="rangement" id="boite5"><img src="shadow.png" class=imageObjets alt="Oups !"></div>
      <div class="rangement" id="boite6"><img src="shadow.png" class=imageObjets alt="Oups !"></div>
      <div class="rangement" id="boite7"><img src="shadow.png" class=imageObjets alt="Oups !"></div>
    </div>

    <script src="carte.js" charset="utf-8"></script>
  </body>

</html>
